/* Full HTML remains unchanged up to existing <script> section */

<script>
  const chatLog = document.getElementById('chat-log');
  const welcomeMsg = document.getElementById('welcome-msg');

  const messages = {
    en: "ü§ñ Hello! I am your AI Concierge for OKay Thai. How can I assist you today?",
    mm: "ü§ñ ·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´·Åã OKay Thai ·Äô·Äæ AI Concierge ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã ·Äò·Ä¨·Äù·Äî·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äæ·ÄØ·Äú·Ä≠·ÄØ·Äï·Ä´·Äû·Äú·Ä≤·Åã",
    th: "ü§ñ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≤‡∏Å OKay Thai ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?"
  };

  function setLanguage(lang) {
    localStorage.setItem('lang', lang);
    welcomeMsg.innerText = messages[lang];
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  }

  window.onload = () => {
    const lang = localStorage.getItem('lang') || 'en';
    const theme = localStorage.getItem('theme') || 'default';
    setLanguage(lang);
    setTheme(theme);
  };

  function appendMessage(message, sender = 'ai') {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `${sender === 'ai' ? 'ü§ñ' : 'üë§'} ${marked.parseInline(message)}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function showLeadForm() {
    document.getElementById('lead-form').style.display = 'flex';
  }

  function readText() {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞');
    utter.lang = 'th-TH';
    synth.speak(utter);
  }

  function showCourseList() {
    appendMessage("We offer: 1. Thai Speaking Only, 2. 4-skills Thai Class, 3. One-on-One, 4. Children‚Äôs Group Class, 5. Private Group Class.");
  }

  function showLecturers() {
    appendMessage("üë©‚Äçüè´ TR. ZAW ‚Äî 5 years teaching experience.\nüë©‚Äçüè´ TR. PHYU ‚Äî Translator at Toyota, 2 years teaching.\nüë©‚Äçüè´ TR. MAY ‚Äî Fluent in Thai, 3 years in Thai Company.");
  }

  // Full Placement Test Logic
  const testQuestions = [
    {
      q: "What does \"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ\" mean?",
      options: ["Goodbye", "Thank you", "Hello", "Please"],
      correct: 2
    },
    {
      q: "What is the Thai word for \"water\"?",
      options: ["‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏ô‡πâ‡∏≥", "‡πÑ‡∏ü", "‡∏õ‡∏•‡∏≤"],
      correct: 1
    },
    {
      q: "Choose the Thai script for \"school\".",
      options: ["‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"],
      correct: 2
    },
    {
      q: "Which tone is used in \"‡∏Ç‡∏≤‡∏ß\" (white)?",
      options: ["Mid", "Rising", "Falling", "Low"],
      correct: 1
    },
    {
      q: "Which Thai sentence means \"I like to learn Thai\"?",
      options: [
        "‡∏â‡∏±‡∏ô‡∏ä‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
        "‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
        "‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
        "‡∏ú‡∏°‡∏ä‡∏≠‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢"
      ],
      correct: 0
    }
  ];

  let currentQuestion = 0;
  let score = 0;

  function startTest() {
    currentQuestion = 0;
    score = 0;
    askQuestion();
  }

  function askQuestion() {
    const q = testQuestions[currentQuestion];
    let msg = `üß† Q${currentQuestion + 1}: ${q.q}`;
    q.options.forEach((opt, i) => {
      msg += `\n${String.fromCharCode(65 + i)}. ${opt}`;
    });
    appendMessage(msg);
    waitForAnswer();
  }

  function waitForAnswer() {
    document.addEventListener('keydown', handleKey);
  }

  function handleKey(e) {
    const key = e.key.toUpperCase();
    const validKeys = ['A', 'B', 'C', 'D'];
    if (!validKeys.includes(key)) return;
    document.removeEventListener('keydown', handleKey);

    const selected = validKeys.indexOf(key);
    const correct = testQuestions[currentQuestion].correct;

    if (selected === correct) {
      appendMessage("‚úÖ Correct!", 'ai');
      score++;
    } else {
      appendMessage(`‚ùå Incorrect. Correct answer is ${String.fromCharCode(65 + correct)}.`, 'ai');
    }

    currentQuestion++;
    if (currentQuestion < testQuestions.length) {
      setTimeout(askQuestion, 1000);
    } else {
      setTimeout(showResult, 1000);
    }
  }

  function showResult() {
    const level = score >= 4 ? 'Advanced' : score >= 2 ? 'Intermediate' : 'Beginner';
    appendMessage(`üéâ You scored ${score}/${testQuestions.length}. Recommended level: **${level}**.`);
    appendMessage(`üì• Would you like to enroll in a class? Click "Enroll Now" to get started.`);
  }

  document.getElementById('lead-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('name').value;
    const contact = document.getElementById('contact').value;
    const interest = document.getElementById('interest').value;

    const payload = { name, contact, interest };

    fetch('YOUR_WEB_APP_URL_HERE', {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      appendMessage(`Thanks, ${name}! We saved your interest in ${interest}. Our team will contact you soon.`);
      document.getElementById('lead-form').reset();
      document.getElementById('lead-form').style.display = 'none';
    })
    .catch(err => {
      console.error('Error saving lead:', err);
      alert('There was a problem saving your lead. Try again.');
    });
  });
</script>
</body>
</html>
